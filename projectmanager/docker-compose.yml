version: "3.8"

x-app-env: &app-env
  DEBUG: ${DEBUG:-0}
  SENTRY_DSN: ${SENTRY_DSN:-""}
  SENTRY_ENVIRONMENT: ${SENTRY_ENVIRONMENT:-production}
  CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-}
  # Database
  POSTGRES_USER: ${POSTGRES_USER:-plane}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-plane}
  POSTGRES_DB: ${POSTGRES_DB:-plane}
  POSTGRES_HOST: plane-db
  POSTGRES_PORT: 5432
  DATABASE_URL: postgresql://${POSTGRES_USER:-plane}:${POSTGRES_PASSWORD:-plane}@plane-db:5432/${POSTGRES_DB:-plane}
  # Redis
  REDIS_HOST: plane-redis
  REDIS_PORT: 6379
  REDIS_URL: redis://plane-redis:6379/
  # Storage
  USE_MINIO: 1
  AWS_REGION: ""
  AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-plane}
  AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-planeminio}
  AWS_S3_ENDPOINT_URL: http://plane-minio:9000
  AWS_S3_BUCKET_NAME: ${AWS_S3_BUCKET_NAME:-uploads}
  MINIO_ROOT_USER: ${MINIO_ROOT_USER:-plane}
  MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-planeminio}
  FILE_SIZE_LIMIT: ${FILE_SIZE_LIMIT:-5242880}
  # Auth
  SECRET_KEY: ${SECRET_KEY:-60gp0byfz2dvffa45cxl20p1scy9xbpf6d8c5y0geez2}
  # URLs
  WEB_URL: ${WEB_URL:-http://localhost}
  NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost/api}
  NEXT_PUBLIC_ADMIN_BASE_URL: ${NEXT_PUBLIC_ADMIN_BASE_URL:-http://localhost/god-mode}
  NEXT_PUBLIC_ADMIN_BASE_PATH: ${NEXT_PUBLIC_ADMIN_BASE_PATH:-/god-mode}
  NEXT_PUBLIC_SPACE_BASE_URL: ${NEXT_PUBLIC_SPACE_BASE_URL:-http://localhost/spaces}
  NEXT_PUBLIC_SPACE_BASE_PATH: ${NEXT_PUBLIC_SPACE_BASE_PATH:-/spaces}
  NEXT_PUBLIC_LIVE_BASE_URL: ${NEXT_PUBLIC_LIVE_BASE_URL:-http://localhost/live}
  NEXT_PUBLIC_LIVE_BASE_PATH: ${NEXT_PUBLIC_LIVE_BASE_PATH:-/live}

services:
  plane-web:
    image: docker.io/makeplane/plane-frontend:stable
    container_name: plane-web
    restart: always
    command: node web/server.js web
    environment:
      <<: *app-env
    depends_on:
      - plane-api
      - plane-worker

  plane-space:
    image: docker.io/makeplane/plane-space:stable
    container_name: plane-space
    restart: always
    command: node space/server.js space
    environment:
      <<: *app-env
    depends_on:
      - plane-api
      - plane-worker
      - plane-web

  plane-admin:
    image: docker.io/makeplane/plane-admin:stable
    container_name: plane-admin
    restart: always
    command: node admin/server.js admin
    environment:
      <<: *app-env
    depends_on:
      - plane-api
      - plane-web

  plane-live:
    image: docker.io/makeplane/plane-live:stable
    container_name: plane-live
    restart: always
    command: node live/server.js live
    environment:
      <<: *app-env
    depends_on:
      - plane-api
      - plane-web

  plane-api:
    image: docker.io/makeplane/plane-backend:stable
    container_name: plane-api
    restart: always
    command: ./bin/api
    environment:
      <<: *app-env
    depends_on:
      - plane-db
      - plane-redis
      - plane-minio

  plane-worker:
    image: docker.io/makeplane/plane-backend:stable
    container_name: plane-worker
    restart: always
    command: ./bin/worker
    environment:
      <<: *app-env
    depends_on:
      - plane-api
      - plane-db
      - plane-redis

  plane-beat-worker:
    image: docker.io/makeplane/plane-backend:stable
    container_name: plane-beat-worker
    restart: always
    command: ./bin/beat
    environment:
      <<: *app-env
    depends_on:
      - plane-api
      - plane-db
      - plane-redis

  plane-migrator:
    image: docker.io/makeplane/plane-backend:stable
    container_name: plane-migrator
    restart: "no"
    command: ./bin/migrate
    environment:
      <<: *app-env
    depends_on:
      - plane-db
      - plane-redis

  plane-db:
    image: docker.io/postgres:15-alpine
    container_name: plane-db
    restart: always
    command: postgres -c 'max_connections=1000'
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-plane}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-plane}
      POSTGRES_DB: ${POSTGRES_DB:-plane}
      PGDATA: /var/lib/postgresql/data
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-plane} -d ${POSTGRES_DB:-plane}"]
      interval: 5s
      timeout: 5s
      retries: 5

  plane-redis:
    image: docker.io/redis:7-alpine
    container_name: plane-redis
    restart: always
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  plane-minio:
    image: docker.io/minio/minio:latest
    container_name: plane-minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-plane}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-planeminio}
    volumes:
      - miniodata:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  plane-minio-init:
    image: docker.io/minio/mc:latest
    container_name: plane-minio-init
    depends_on:
      plane-minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set plane-minio http://plane-minio:9000 ${MINIO_ROOT_USER:-plane} ${MINIO_ROOT_PASSWORD:-planeminio};
      mc mb plane-minio/${AWS_S3_BUCKET_NAME:-uploads} --ignore-existing;
      mc anonymous set download plane-minio/${AWS_S3_BUCKET_NAME:-uploads};
      exit 0;
      "

  plane-proxy:
    image: docker.io/makeplane/plane-proxy:stable
    container_name: plane-proxy
    restart: always
    ports:
      - "${NGINX_PORT:-80}:80"
    environment:
      BUCKET_NAME: ${AWS_S3_BUCKET_NAME:-uploads}
      FILE_SIZE_LIMIT: ${FILE_SIZE_LIMIT:-5242880}
    depends_on:
      - plane-web
      - plane-api
      - plane-space

volumes:
  pgdata:
  redisdata:
  miniodata:
